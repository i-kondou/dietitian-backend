# Dietitian API

AI ã‚’æ´»ç”¨ã—ãŸæ „é¤Šç®¡ç†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API ã§ã™ã€‚æ–™ç†ã®ç”»åƒã‹ã‚‰æ „é¤Šæƒ…å ±ã‚’è‡ªå‹•è§£æã—ã€å€‹äººã®èº«ä½“æƒ…å ±ã«åŸºã¥ã„ãŸãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸå¥åº·ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ“– æ¦‚è¦

Dietitian API ã¯ã€Google ã® Gemini AI ãƒ¢ãƒ‡ãƒ«ã¨ Firebase ã‚’æ´»ç”¨ã—ãŸæ „é¤Šç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–™ç†ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€AI ãŒæ–™ç†ã‚’è‡ªå‹•èªè­˜ã—ã€æ „é¤Šæˆåˆ†ã‚’æ¨å®šã—ã¦ã€å€‹äººã®èº«ä½“æƒ…å ±ã«åŸºã¥ã„ãŸã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸå¥åº·ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### ä¸»ãªæ©Ÿèƒ½

- ğŸ½ï¸ **æ–™ç†ç”»åƒèªè­˜**: AI ã«ã‚ˆã‚‹æ–™ç†ã®è‡ªå‹•æ¤œå‡ºã¨åå‰ã®ç‰¹å®š
- ğŸ“Š **æ „é¤Šæˆåˆ†åˆ†æ**: ã‚«ãƒ­ãƒªãƒ¼ã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã€è„‚è³ªã€ç‚­æ°´åŒ–ç‰©ãªã©ã®è©³ç´°ãªæ „é¤Šæˆåˆ†æ¨å®š
- ğŸ‘¤ **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†**: èº«é•·ã€ä½“é‡ã€å¹´é½¢ã€æ€§åˆ¥ã«åŸºã¥ãå€‹äººæƒ…å ±ç®¡ç†
- ğŸ’¡ **ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹**: å€‹äººã®èº«ä½“æƒ…å ±ã¨é£Ÿäº‹å†…å®¹ã«åŸºã¥ã„ãŸå¥åº·ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ğŸ“± **Firebase çµ±åˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¨ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
- ğŸ” **JWT èªè¨¼**: ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **Backend Framework**: FastAPI
- **AI/ML**: Google Gemini 2.5 Flash (LangChain çµŒç”±)
- **Database**: Google Cloud Firestore
- **Authentication**: Firebase Auth
- **Image Processing**: Pillow
- **Python Version**: 3.12+

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api.py                          # FastAPI ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ deps.py                     # ä¾å­˜æ€§æ³¨å…¥ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
â”‚   â”‚   â”œâ”€â”€ firebase.py                 # Firebase åˆæœŸåŒ–è¨­å®š
â”‚   â”‚   â””â”€â”€ nutrition_advice_agent/     # AI æ „é¤Šã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
â”‚   â”‚       â”œâ”€â”€ common.py               # å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚       â”œâ”€â”€ step1_dish_detect.py    # ã‚¹ãƒ†ãƒƒãƒ—1: æ–™ç†æ¤œå‡º
â”‚   â”‚       â”œâ”€â”€ step2_nutrition.py      # ã‚¹ãƒ†ãƒƒãƒ—2: æ „é¤Šæˆåˆ†åˆ†æ
â”‚   â”‚       â”œâ”€â”€ step3_advice.py         # ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
â”‚   â”‚       â””â”€â”€ step4_total.py          # ã‚¹ãƒ†ãƒƒãƒ—4: æ „é¤Šæˆåˆ†åˆè¨ˆ
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ meal.py                     # é£Ÿäº‹é–¢é€£ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â””â”€â”€ user.py                     # ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â””â”€â”€ schemas/
â”‚       â”œâ”€â”€ meal.py                     # é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
â”‚       â””â”€â”€ user.py                     # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
â”œâ”€â”€ secrets/                            # Firebase èªè¨¼ã‚­ãƒ¼
â”œâ”€â”€ Dockerfile                          # æœ¬ç•ªç”¨ Docker è¨­å®š
â”œâ”€â”€ Dockerfile.dev                      # é–‹ç™ºç”¨ Docker è¨­å®š
â””â”€â”€ pyproject.toml                      # Python ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
```

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### å‰ææ¡ä»¶

- Python 3.12+
- Docker & Docker Compose
- Google Cloud ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- Google AI Studio API ã‚­ãƒ¼

### ç’°å¢ƒå¤‰æ•°

ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š

```bash
GOOGLE_API_KEY=your_google_api_key
FIREBASE_ADMINSDK_JSON=/secrets/firebase-adminsdk.json
```

### Firebase è¨­å®š

1. Firebase ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
2. Firestore ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æœ‰åŠ¹åŒ–
3. Firebase Admin SDK ã®ç§˜å¯†éµã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
4. `backend/secrets/firebase-adminsdk.json` ã«é…ç½®

### Docker ã‚’ä½¿ç”¨ã—ãŸèµ·å‹•

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone <repository-url>
cd dietitian

# Docker Compose ã§èµ·å‹•
docker-compose up --build
```

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ

```bash
cd backend

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -e .

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
uvicorn src.api:app --host 0.0.0.0 --port 8080 --reload
```

## ğŸ“š API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

#### `POST /user/create`
æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã¾ãŸã¯æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—

```json
{
  "uid": "user123",
  "name": "",
  "height": 0.0,
  "weight": 0.0,
  "sex": "male",
  "age": 0
}
```

#### `POST /user/update`
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°

```json
{
  "name": "ç”°ä¸­å¤ªéƒ",
  "height": 170.5,
  "weight": 65.0,
  "sex": "ç”·æ€§",
  "age": 30
}
```

#### `GET /user/read`
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—

### é£Ÿäº‹ç®¡ç†

#### `POST /meal/upload`
æ–™ç†ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦æ „é¤Šåˆ†æã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```json
{
  "image_url": "https://example.com/food-image.jpg"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "menu_name": "å”æšã’, ã‚µãƒ©ãƒ€, ã”é£¯",
  "calorie": 650.5,
  "protein": 25.2,
  "fat": 18.7,
  "carbohydrate": 85.3,
  "dietary_fiber": 4.2,
  "vitamin": 0.8,
  "mineral": 1.5,
  "sodium": 2.1,
  "advice_message": "ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸé£Ÿäº‹ã§ã™ãŒã€å¡©åˆ†ãŒå°‘ã—å¤šã‚ã§ã™ã€‚é‡èœã‚’å¤šã‚ã«æ‘‚å–ã—ã€æ°´åˆ†è£œçµ¦ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚"
}
```

## ğŸ¤– AI æ „é¤Šã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ä»•çµ„ã¿

Dietitian API ã® AI ã‚·ã‚¹ãƒ†ãƒ ã¯ã€4ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å‹•ä½œã—ã¾ã™ï¼š

### Step 1: æ–™ç†æ¤œå‡º (`step1_dish_detect.py`)
- Gemini Vision API ã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‹ã‚‰æ–™ç†ã‚’è‡ªå‹•èªè­˜
- é‡è¤‡ã‚’é™¤ã„ãŸæ–™ç†åãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ

### Step 2: æ „é¤Šæˆåˆ†åˆ†æ (`step2_nutrition.py`)
- æ¤œå‡ºã•ã‚ŒãŸæ–™ç†ã¨ç”»åƒã‹ã‚‰æ „é¤Šæˆåˆ†ã‚’æ¨å®š
- ã‚«ãƒ­ãƒªãƒ¼ã€ä¸‰å¤§æ „é¤Šç´ ã€ãƒ“ã‚¿ãƒŸãƒ³ã€ãƒŸãƒãƒ©ãƒ«ç­‰ã‚’ç®—å‡º

### Step 3: ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ (`step3_advice.py`)
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å€‹äººæƒ…å ±ï¼ˆèº«é•·ã€ä½“é‡ã€å¹´é½¢ã€æ€§åˆ¥ï¼‰ã‚’è€ƒæ…®
- æ „é¤Šæˆåˆ†ãƒ‡ãƒ¼ã‚¿ã¨çµ„ã¿åˆã‚ã›ã¦ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆ

### Step 4: ç·æ „é¤Šè¨ˆç®— (`step4_total.py`)
- è¤‡æ•°ã®æ–™ç†ã®æ „é¤Šæˆåˆ†ã‚’åˆè¨ˆ
- æœ€çµ‚çš„ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰

## ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

### Users Collection
```
users/{uid}
â”œâ”€â”€ name: string
â”œâ”€â”€ height: number
â”œâ”€â”€ weight: number
â”œâ”€â”€ sex: string
â”œâ”€â”€ age: number
â”œâ”€â”€ createdAt: timestamp
â”œâ”€â”€ updatedAt: timestamp
â””â”€â”€ meals/{mealId}
    â”œâ”€â”€ imageUrl: string
    â”œâ”€â”€ menu_name: string
    â”œâ”€â”€ calorie: number
    â”œâ”€â”€ protein: number
    â”œâ”€â”€ fat: number
    â”œâ”€â”€ carbohydrate: number
    â”œâ”€â”€ dietary_fiber: number
    â”œâ”€â”€ vitamin: number
    â”œâ”€â”€ mineral: number
    â”œâ”€â”€ sodium: number
    â”œâ”€â”€ advice_message: string
    â””â”€â”€ eatenAt: timestamp
```

## ğŸ” èªè¨¼

Firebase Authentication ã‚’ä½¿ç”¨ã—ãŸ JWT ãƒ™ãƒ¼ã‚¹ã®èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```python
# Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã« Bearer ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸
headers = {
    "Authorization": "Bearer <firebase-id-token>"
}
```

## ğŸ§ª é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆ

```bash
# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
ruff format src/

# ãƒªãƒ³ã‚¿ãƒ¼å®Ÿè¡Œ
ruff check src/

# å‹ãƒã‚§ãƒƒã‚¯
pyright src/
```

## ğŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯é–‹ç™ºä¸­ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã™ã€‚

## ğŸ‘¥ ä½œè€…

- i-kondou (u573077g@ecs.osaka-u.ac.jp)

## ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Firebase Documentation](https://firebase.google.com/docs)
- [Google AI Studio](https://aistudio.google.com/)
- [LangChain Documentation](https://python.langchain.com/)

---

**æ³¨æ„**: ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ç‰ˆã§ã™ã€‚æ „é¤Šæˆåˆ†ã®æ¨å®šå€¤ã¯å‚è€ƒå€¤ã§ã‚ã‚Šã€æ­£ç¢ºãªæ „é¤Šç®¡ç†ã«ã¯å°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
